# COMNETX Container (create_from_image.sh)

Контейнер на основе публичного образа `diaduskaau/comnetx`. Скрипт `create_from_image.sh` создаёт и запускает контейнер, позволяет задать размер shared memory (`/dev/shm`), при необходимости пересоздаёт контейнер и (по запросу) может сохранить изменения обратно в образ и запушить их.

## Требования

- Установлен и запущен Docker (`docker --version`).
- Для GPU: установлен NVIDIA Container Toolkit; на хосте доступна команда `nvidia-smi`.
- Образ `diaduskaau/comnetx:latest` публично доступен (pull без логина).
- На сервере существуют каталоги, которые монтирует скрипт:
  - `/auto/datasets/graphs`
  - `/home/$USER`

## Быстрый старт

- Сделать скрипт исполняемым:
  - `chmod +x ./create_from_image.sh`
- Запустить контейнер с именем и shm-size:
  - `./create_from_image.sh -n myproj -m 16g`
- Пересоздать при конфликте имени:
  - `./create_from_image.sh -n myproj -m 16g -r`

## Параметры

- `-n NAME` — логическое имя проекта; реальное имя контейнера будет `${USER}_NAME` (пример: `drobyshev_myproj`).
- `-m SHM_SIZE` — размер `/dev/shm` (по умолчанию `2g`).
  - Одна GPU (8–16 ГБ VRAM): обычно достаточно `-m 8g`.
  - Несколько GPU / DDP / большие батчи: используйте `-m 16g` или `-m 32g`.
- `-r` — пересоздать контейнер, если одноимённый существует.
- `-h` — вывести справку по скрипту.

Пример:
- `./create_from_image.sh -n research -m 32g -r`

## Что делает скрипт

- Создаёт контейнер из `diaduskaau/comnetx:latest` с заданным `--shm-size`.
- Монтирует директории (`/auto/datasets/graphs`, `/home/$USER`) и запускает интерактивный shell.
- По завершении входа контейнер продолжит работу, если не завершён основной процесс внутри.

## Проверка GPU внутри контейнера

- `nvidia-smi` — проверка видимости GPU.
- `python -c "import torch; print(torch.cuda.is_available())"` — проверка PyTorch CUDA.
- Если GPU не виден: установите NVIDIA Container Toolkit на хосте и убедитесь, что `nvidia-smi` доступен вне контейнера.

## Каталоги (по умолчанию)

- `-v /auto/datasets/graphs:/auto/datasets/graphs` — общий датасет.
- `-v /home/$USER:/home/$USER` — домашняя директория пользователя.
- Если пути отсутствуют на новом сервере, удалите или замените соответствующие `-v`, иначе `docker create` завершится ошибкой.

## Несколько контейнеров для разных пользователей

- Запускайте скрипт под каждым пользователем с уникальным `-n`, чтобы получить разные имена контейнеров (`${USER}_suffix`) и корректные монтирования `/home/<user>`.
- Для распределения GPU можно расширить скрипт опцией маски устройств `--gpus "device=0,1"` (при необходимости).

## Сохранение изменений (опционально)

- Скрипт может спросить:
  - Сохранить изменения в образ (`docker commit`)?
  - Отправить обновлённый образ в реестр (`docker push`)?
- Для push требуется предварительный логин в реестр: `docker login`.
- Рекомендуется использовать версионированные теги и обновлять `latest` после проверки.

## Полезные команды

- Список контейнеров: `docker ps -a`
- Логи: `docker logs <name> | tail -n 100`
- Войти внутрь: `docker exec -it <name> bash`
- Остановить/удалить: `docker stop <name> && docker rm <name>`